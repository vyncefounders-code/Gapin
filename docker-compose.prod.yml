services:
  # -----------------------------------------------------
  # GATEWAY
  # -----------------------------------------------------
  gateway:
    build:
      context: .
      dockerfile: ./packages/gateway/Dockerfile

    container_name: gapin-gateway
    restart: always

    env_file:
      - ./infra/.env.prod

    ports:
      - "80:3000"

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -----------------------------------------------------
  # POSTGRES
  # -----------------------------------------------------
  postgres:
    image: postgres:15
    container_name: gapin-postgres
    restart: always

    env_file:
      - ./infra/.env.prod

    volumes:
      - pgdata:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -----------------------------------------------------
  # REDIS
  # -----------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: gapin-redis
    restart: always

    volumes:
      - redisdata:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # -----------------------------------------------------
  # REDPANDA
  # -----------------------------------------------------
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: gapin-redpanda
    restart: always

    command:
      - redpanda start
      - --overprovisioned
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --check=false

    ports:
      - "9092:9092"

    volumes:
      - redpandadata:/var/lib/redpanda/data

    healthcheck:
      test: ["CMD", "rpk", "cluster", "info"]
      interval: 15s
      timeout: 10s
      retries: 5

  # -----------------------------------------------------
  # NGINX
  # -----------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: gapin-nginx
    restart: always

    depends_on:
      gateway:
        condition: service_healthy

    ports:
      - "443:443"
      - "80:80"

    volumes:
      - ./infra/nginx/prod.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/certs:/etc/nginx/certs:ro

volumes:
  pgdata:
  redisdata:
  redpandadata:
